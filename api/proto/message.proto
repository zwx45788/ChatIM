syntax = "proto3";

package proto.message;

option go_package = "ChatIM/api/proto/message";

// 定义消息数据结构
message Message {
  string id = 1;          // 消息唯一ID (UUID)
  string from_user_id = 2; // 发送者ID
  string to_user_id = 3;   // 接收者ID (私聊场景)
  string content = 4;      // 消息内容
  int64 created_at = 5;    // 创建时间 (Unix时间戳)
  bool is_read = 6;        // 是否已读
  int64 read_at = 7;       // 已读时间 (Unix时间戳)
}

// 发送消息的请求
message SendMessageRequest {
  string to_user_id = 1;   // 发送给谁
  string content = 2;      // 消息内容
}

// 发送消息的响应
message SendMessageResponse {
  int32 code = 1;
  string message = 2;
  Message msg = 3; // 返回成功存储的消息详情
}
//拉取消息的请求
message PullMessagesRequest{
  int64 limit = 1;
  int64 offset = 2;
}
//拉取消息的响应
message PullMessagesResponse{
  int32 code = 1;
  string message = 2;
  repeated Message msgs = 3;
}

// 标记消息已读的请求
message MarkMessagesAsReadRequest {
  repeated string message_ids = 1; // 需要标记为已读的消息ID列表
}

// 标记消息已读的响应
message MarkMessagesAsReadResponse {
  int32 code = 1;
  string message = 2;
  int32 marked_count = 3; // 成功标记的消息数量
}

// 获取未读消息数的请求
message GetUnreadCountRequest {
}

// 获取未读消息数的响应
message GetUnreadCountResponse {
  int32 code = 1;
  string message = 2;
  int32 unread_count = 3; // 未读消息总数
}

// 拉取未读消息的请求
message PullUnreadMessagesRequest {
  int64 limit = 1;        // 单次拉取上限（建议 100）
  bool auto_mark = 2;     // 是否自动标记为已读
}

// 拉取未读消息的响应
message PullUnreadMessagesResponse {
  int32 code = 1;
  string message = 2;
  repeated Message msgs = 3;      // 未读消息列表
  int32 total_unread = 4;         // 拉取前的总未读数
  bool has_more = 5;              // 是否还有更多未读消息
}

// 登录时拉取所有未读消息的请求
message PullAllUnreadOnLoginRequest {
}

// 群聊未读消息详情
message GroupUnreadInfo {
  string group_id = 1;
  int32 unread_count = 2;
  repeated Message messages = 3;
}

// 登录时拉取所有未读消息的响应
message PullAllUnreadOnLoginResponse {
  int32 code = 1;
  string message = 2;
  repeated Message private_messages = 3;
  int32 private_unread_count = 4;
  map<string, GroupUnreadInfo> group_messages = 5;
  int32 group_unread_count = 6;
  int32 total_unread_count = 7;
  string pulled_at = 8;
}

// 标记私聊消息已读请求
message MarkPrivateMessageAsReadRequest {
  string message_id = 1;
}

// 标记私聊消息已读响应
message MarkPrivateMessageAsReadResponse {
  int32 code = 1;
  string message = 2;
}

// 标记群聊消息已读请求
message MarkGroupMessageAsReadRequest {
  string group_id = 1;
  string last_read_message_id = 2;
}

// 标记群聊消息已读响应
message MarkGroupMessageAsReadResponse {
  int32 code = 1;
  string message = 2;
}

// 定义消息服务
service MessageService {
  // 发送一条私聊消息
  rpc SendMessage (SendMessageRequest) returns (SendMessageResponse);
  // 拉取消息
  rpc PullMessages (PullMessagesRequest) returns (PullMessagesResponse);
  // 标记消息已读
  rpc MarkMessagesAsRead (MarkMessagesAsReadRequest) returns (MarkMessagesAsReadResponse);
  // 获取未读消息数
  rpc GetUnreadCount (GetUnreadCountRequest) returns (GetUnreadCountResponse);
  // 拉取所有未读消息（新增）
  rpc PullUnreadMessages (PullUnreadMessagesRequest) returns (PullUnreadMessagesResponse);
  // 登录时拉取所有未读消息
  rpc PullAllUnreadOnLogin (PullAllUnreadOnLoginRequest) returns (PullAllUnreadOnLoginResponse);
  // 标记私聊消息已读
  rpc MarkPrivateMessageAsRead (MarkPrivateMessageAsReadRequest) returns (MarkPrivateMessageAsReadResponse);
  // 标记群聊消息已读
  rpc MarkGroupMessageAsRead (MarkGroupMessageAsReadRequest) returns (MarkGroupMessageAsReadResponse);
}
