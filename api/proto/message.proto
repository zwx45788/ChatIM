syntax = "proto3";

package proto.message;

option go_package = "ChatIM/api/proto/message";

// 定义消息数据结构
message Message {
  string id = 1;          // 消息唯一ID (UUID)
  string from_user_id = 2; // 发送者ID
  string to_user_id = 3;   // 接收者ID (私聊场景)
  string content = 4;      // 消息内容
  int64 created_at = 5;    // 创建时间 (Unix时间戳)
  bool is_read = 6;        // 是否已读
  int64 read_at = 7;       // 已读时间 (Unix时间戳)
}

// 群聊消息数据结构
message GroupMessage {
  string id = 1;          // 消息唯一ID
  string group_id = 2;    // 群组ID
  string from_user_id = 3; // 发送者ID
  string content = 4;      // 消息内容
  int64 created_at = 5;    // 创建时间
}

// 发送消息的请求
message SendMessageRequest {
  string to_user_id = 1;   // 发送给谁
  string content = 2;      // 消息内容
}

// 发送消息的响应
message SendMessageResponse {
  int32 code = 1;
  string message = 2;
  Message msg = 3; // 返回成功存储的消息详情
}

// 发送群聊消息的请求
message SendGroupMessageRequest {
  string group_id = 1;  // 群组ID
  string content = 2;   // 消息内容
}

// 发送群聊消息的响应
message SendGroupMessageResponse {
  int32 code = 1;
  string message = 2;
  GroupMessage msg = 3; // 返回成功存储的群聊消息详情
}
// 会话消息（按会话分组）
message ConversationMessages {
  string conversation_id = 1;   // 会话ID: "private:user_id" 或 "group:group_id"
  string type = 2;              // 会话类型: "private" 或 "group"
  string peer_id = 3;           // 对方用户ID或群组ID
  string peer_name = 4;         // 对方昵称或群名（可选）
  string peer_avatar = 5;       // 对方头像（可选）
  int32 unread_count = 6;       // 该会话未读消息数
  repeated UnifiedMessage messages = 7; // 该会话的消息列表
  int64 last_message_time = 8;  // 最后一条消息时间
}

// 统一消息格式（支持私聊和群聊）
message UnifiedMessage {
  string id = 1;               // 消息ID
  string type = 2;             // "private" 或 "group"
  string from_user_id = 3;     // 发送者ID
  string from_user_name = 4;   // 发送者昵称（可选）
  string to_user_id = 5;       // 接收者ID（私聊）
  string group_id = 6;         // 群组ID（群聊）
  string content = 7;          // 消息内容
  int64 created_at = 8;        // 时间戳（秒）
  bool is_read = 9;            // 是否已读
  string stream_id = 10;       // Stream 消息ID（用于分页）
}

//拉取消息的请求(改为拉取按会话分组的未读消息)
message PullMessagesRequest{
  int64 limit = 1;             // 每个会话最多拉取的消息数(默认20)
  bool auto_mark = 2;          // 是否自动标记为已读(默认false)
  bool include_read = 3;       // 是否包含已读消息(默认false,只返回未读)
  string from_stream_id = 4;   // 从该 Stream ID 之后开始拉取(用于增量拉取)
}

//拉取消息的响应（返回结构化的会话列表）
message PullMessagesResponse{
  int32 code = 1;
  string message = 2;
  repeated ConversationMessages conversations = 3; // 按会话分组的消息
  int32 total_unread = 4;      // 总未读消息数
  int32 conversation_count = 5; // 有未读消息的会话数
}

// 获取未读消息数的请求
message GetUnreadCountRequest {
}

// 获取未读消息数的响应
message GetUnreadCountResponse {
  int32 code = 1;
  string message = 2;
  int32 unread_count = 3; // 未读消息总数
}

// 拉取未读消息的请求
message PullUnreadMessagesRequest {
  int64 limit = 1;        // 单次拉取上限（建议 100）
  bool auto_mark = 2;     // 是否自动标记为已读
}

// 拉取未读消息的响应
message PullUnreadMessagesResponse {
  int32 code = 1;
  string message = 2;
  repeated Message msgs = 3;      // 未读消息列表
  int32 total_unread = 4;         // 拉取前的总未读数
  bool has_more = 5;              // 是否还有更多未读消息
}

// 登录时拉取所有未读消息的请求
message PullAllUnreadOnLoginRequest {
}

// 群聊未读消息详情
message GroupUnreadInfo {
  string group_id = 1;
  int32 unread_count = 2;
  repeated Message messages = 3;
}

// 登录时拉取所有未读消息的响应
message PullAllUnreadOnLoginResponse {
  int32 code = 1;
  string message = 2;
  repeated Message private_messages = 3;
  int32 private_unread_count = 4;
  map<string, GroupUnreadInfo> group_messages = 5;
  int32 group_unread_count = 6;
  int32 total_unread_count = 7;
  string pulled_at = 8;
}

// 标记私聊消息已读请求
message MarkPrivateMessageAsReadRequest {
  string message_id = 1;
}

// 标记私聊消息已读响应
message MarkPrivateMessageAsReadResponse {
  int32 code = 1;
  string message = 2;
}

// 标记群聊消息已读请求
message MarkGroupMessageAsReadRequest {
  string group_id = 1;
  string last_read_message_id = 2;
}

// 标记群聊消息已读响应
message MarkGroupMessageAsReadResponse {
  int32 code = 1;
  string message = 2;
}

// 拉取群聊消息请求
message PullGroupMessagesRequest {
  string group_id = 1;     // 群组ID
  int64 limit = 2;         // 单次拉取上限
  int64 offset = 3;        // 分页偏移量
}

// 拉取群聊消息响应
message PullGroupMessagesResponse {
  int32 code = 1;
  string message = 2;
  repeated GroupMessage messages = 3; // 群聊消息列表
  int32 total = 4;         // 总消息数（可选）
  bool has_more = 5;       // 是否还有更多消息
}

// 更新已读游标请求
message UpdateLastSeenCursorRequest {
  string conversation_type = 1; // "private" 或 "group"
  string peer_id = 2;           // 对方用户ID或群组ID
  string last_seen_stream_id = 3; // 最后已读的 Stream ID
}

// 更新已读游标响应
message UpdateLastSeenCursorResponse {
  int32 code = 1;
  string message = 2;
  string cursor = 3;            // 更新后的游标值
}

// 定义消息服务
service MessageService {
  // 发送一条私聊消息
  rpc SendMessage (SendMessageRequest) returns (SendMessageResponse);
  // 发送一条群聊消息
  rpc SendGroupMessage (SendGroupMessageRequest) returns (SendGroupMessageResponse);
  // 拉取消息
  rpc PullMessages (PullMessagesRequest) returns (PullMessagesResponse);
  // [DEPRECATED: 此接口已弃用] 获取未读消息数
  rpc GetUnreadCount (GetUnreadCountRequest) returns (GetUnreadCountResponse);
  // 更新已读游标
  rpc UpdateLastSeenCursor (UpdateLastSeenCursorRequest) returns (UpdateLastSeenCursorResponse);
  // [DEPRECATED: 此接口已弃用]
  // 拉取所有未读消息。建议改为使用 PullMessages 拉取按会话分组的消息，并用 GetUnreadCount 获取总数。
  rpc PullUnreadMessages (PullUnreadMessagesRequest) returns (PullUnreadMessagesResponse);
  // [DEPRECATED: 此接口已弃用]
  // 登录时拉取所有未读消息。建议改为：
  // 1. 上线时调用 PullMessages 拉取按会话分组的消息（用于初始化会话列表）
  // 2. 使用 GetUnreadCount 获取未读总数
  // 3. 在线消息通过 WebSocket 推送，无需轮询此接口
  rpc PullAllUnreadOnLogin (PullAllUnreadOnLoginRequest) returns (PullAllUnreadOnLoginResponse);
  // 标记私聊消息已读
  rpc MarkPrivateMessageAsRead (MarkPrivateMessageAsReadRequest) returns (MarkPrivateMessageAsReadResponse);
  // 标记群聊消息已读
  rpc MarkGroupMessageAsRead (MarkGroupMessageAsReadRequest) returns (MarkGroupMessageAsReadResponse);
  // 拉取群聊消息
  rpc PullGroupMessages (PullGroupMessagesRequest) returns (PullGroupMessagesResponse);
}
