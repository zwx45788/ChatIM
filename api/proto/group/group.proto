syntax = "proto3";

package group;
option go_package = "ChatIM/api/proto/group";

// 群组相关消息定义

message CreateGroupRequest {
  string name = 1;
  string description = 2;
  repeated string member_ids = 3;  // 初始成员ID列表
}

message CreateGroupResponse {
  int32 code = 1;
  string message = 2;
  string group_id = 3;
}

message GroupInfo {
  string id = 1;
  string name = 2;
  string description = 3;
  string creator_id = 4;
  int64 created_at = 5;
  int32 member_count = 6;
}

message GetGroupInfoRequest {
  string group_id = 1;
}

message GetGroupInfoResponse {
  int32 code = 1;
  string message = 2;
  GroupInfo group = 3;
}

message GroupMessage {
  string id = 1;
  string group_id = 2;
  string from_user_id = 3;
  string content = 4;
  string msg_type = 5;  // text, image, file, notice
  int64 created_at = 6;
}

message SendGroupMessageRequest {
  string group_id = 1;
  string content = 2;
  string msg_type = 3;
}

message SendGroupMessageResponse {
  int32 code = 1;
  string message = 2;
  GroupMessage msg = 3;
}

message PullGroupMessagesRequest {
  string group_id = 1;
  int64 limit = 2;
  int64 offset = 3;
  string before_msg_id = 4;  // 用于翻页，查询该消息之前的消息
}

message PullGroupMessagesResponse {
  int32 code = 1;
  string message = 2;
  repeated GroupMessage msgs = 3;
}

message PullGroupUnreadMessagesRequest {
  string group_id = 1;
  int64 limit = 2;
}

message PullGroupUnreadMessagesResponse {
  int32 code = 1;
  string message = 2;
  repeated GroupMessage msgs = 3;
  int32 total_unread = 4;
}

message GetGroupUnreadCountRequest {
  string group_id = 1;
}

message GetGroupUnreadCountResponse {
  int32 code = 1;
  string message = 2;
  int32 unread_count = 3;
}

message AddGroupMemberRequest {
  string group_id = 1;
  repeated string user_ids = 2;
}

message AddGroupMemberResponse {
  int32 code = 1;
  string message = 2;
  int32 added_count = 3;
}

message RemoveGroupMemberRequest {
  string group_id = 1;
  repeated string user_ids = 2;
}

message RemoveGroupMemberResponse {
  int32 code = 1;
  string message = 2;
  int32 removed_count = 3;
}

message LeaveGroupRequest {
  string group_id = 1;
}

message LeaveGroupResponse {
  int32 code = 1;
  string message = 2;
}

message ListGroupsRequest {
  int64 limit = 1;
  int64 offset = 2;
}

message ListGroupsResponse {
  int32 code = 1;
  string message = 2;
  repeated GroupInfo groups = 3;
  int32 total = 4;
}

message GroupUnreadInfo {
  string group_id = 1;
  string group_name = 2;
  int32 unread_count = 3;
  repeated GroupMessage latest_messages = 4;  // 最新的几条未读消息
}

message PullAllGroupsUnreadMessagesRequest {
  int64 limit = 1;  // 每个群最多拉取多少条未读消息
}

message PullAllGroupsUnreadMessagesResponse {
  int32 code = 1;
  string message = 2;
  repeated GroupUnreadInfo group_unreads = 3;  // 每个群的未读信息
  int32 total_unread_count = 4;  // 所有群的总未读数
}

service GroupService {
  rpc CreateGroup(CreateGroupRequest) returns (CreateGroupResponse);
  rpc GetGroupInfo(GetGroupInfoRequest) returns (GetGroupInfoResponse);
  rpc SendGroupMessage(SendGroupMessageRequest) returns (SendGroupMessageResponse);
  rpc PullGroupMessages(PullGroupMessagesRequest) returns (PullGroupMessagesResponse);
  rpc PullGroupUnreadMessages(PullGroupUnreadMessagesRequest) returns (PullGroupUnreadMessagesResponse);
  rpc GetGroupUnreadCount(GetGroupUnreadCountRequest) returns (GetGroupUnreadCountResponse);
  rpc AddGroupMember(AddGroupMemberRequest) returns (AddGroupMemberResponse);
  rpc RemoveGroupMember(RemoveGroupMemberRequest) returns (RemoveGroupMemberResponse);
  rpc LeaveGroup(LeaveGroupRequest) returns (LeaveGroupResponse);
  rpc ListGroups(ListGroupsRequest) returns (ListGroupsResponse);
  rpc PullAllGroupsUnreadMessages(PullAllGroupsUnreadMessagesRequest) returns (PullAllGroupsUnreadMessagesResponse);
}
