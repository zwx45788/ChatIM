# å‹è°ŠæœåŠ¡åŠŸèƒ½æ¸…å• - å®Œæ•´ç‰ˆ

## ğŸ“‹ RPC æ–¹æ³•æ€»è§ˆ

### å¥½å‹ç›¸å…³åŠŸèƒ½

| # | æ–¹æ³•å | åŠŸèƒ½è¯´æ˜ | æƒé™ | çŠ¶æ€ |
|---|--------|--------|------|------|
| 1 | SendFriendRequest | å‘é€å¥½å‹è¯·æ±‚ | å·²è®¤è¯ç”¨æˆ· | âœ… |
| 2 | GetFriendRequests | è·å–å¥½å‹è¯·æ±‚åˆ—è¡¨ | å·²è®¤è¯ç”¨æˆ· | âœ… |
| 3 | ProcessFriendRequest | æ¥å—/æ‹’ç»å¥½å‹è¯·æ±‚ | è¯·æ±‚æ¥æ”¶è€… | âœ… |
| 4 | GetFriends | è·å–å¥½å‹åˆ—è¡¨ | å·²è®¤è¯ç”¨æˆ· | âœ… |
| 5 | RemoveFriend | åˆ é™¤å¥½å‹ | å·²è®¤è¯ç”¨æˆ· | âœ… **æ–°** |

### ç¾¤ç»„ç›¸å…³åŠŸèƒ½

| # | æ–¹æ³•å | åŠŸèƒ½è¯´æ˜ | æƒé™ | çŠ¶æ€ |
|---|--------|--------|------|------|
| 6 | SendGroupJoinRequest | ç”³è¯·åŠ å…¥ç¾¤ç»„ | å·²è®¤è¯ç”¨æˆ· | âœ… |
| 7 | GetGroupJoinRequests | æŸ¥çœ‹ç¾¤ç”³è¯·åˆ—è¡¨ | ç¾¤ä¸»/ç®¡ç†å‘˜ | âœ… |
| 8 | ProcessGroupJoinRequest | å®¡æ‰¹ç¾¤ç”³è¯· | ç¾¤ä¸»/ç®¡ç†å‘˜ | âœ… |
| 9 | GetUserGroups | è·å–ç”¨æˆ·æ‰€åœ¨ç¾¤ç»„ | å·²è®¤è¯ç”¨æˆ· | âœ… |
| 10 | LeaveGroup | é€€å‡ºç¾¤ç»„ | å·²è®¤è¯ç”¨æˆ· | âœ… **æ–°** |
| 11 | RemoveGroupMember | è¸¢å‡ºç¾¤æˆå‘˜ | ç¾¤ä¸» | âœ… **æ–°** |

## ğŸ¯ åŠŸèƒ½å¯¹ç…§è¡¨

### å‘èµ·æ“ä½œ

| æ“ä½œ | å¯¹è±¡ | æ–¹æ³• | è¿”å›å€¼ | å¤‡æ³¨ |
|------|------|------|--------|------|
| ç”³è¯·åŠ å¥½å‹ | ç”¨æˆ· | SendFriendRequest | request_id | å¯é™„åŠ ä¿¡æ¯ |
| ç”³è¯·åŠ ç¾¤ | ç¾¤ç»„ | SendGroupJoinRequest | request_id | å¯é™„åŠ ä¿¡æ¯ |
| åˆ é™¤å¥½å‹ | ç”¨æˆ· | RemoveFriend | çŠ¶æ€ä¿¡æ¯ | å•å‘åˆ é™¤ |

### æŸ¥è¯¢æ“ä½œ

| æŸ¥è¯¢å†…å®¹ | æ–¹æ³• | è¿”å›æ•°æ® | æƒé™ | åˆ†é¡µ |
|---------|------|--------|------|------|
| å¾…å¤„ç†å¥½å‹ç”³è¯· | GetFriendRequests | ç”³è¯·åˆ—è¡¨ + æ€»æ•° | è‡ªå·± | âœ… |
| å·²å¤„ç†å¥½å‹ç”³è¯· | GetFriendRequests | ç”³è¯·åˆ—è¡¨ + æ€»æ•° | è‡ªå·± | âœ… |
| å¥½å‹åˆ—è¡¨ | GetFriends | å¥½å‹åˆ—è¡¨ + æ€»æ•° | è‡ªå·± | âœ… |
| ç¾¤ç”³è¯·åˆ—è¡¨ | GetGroupJoinRequests | ç”³è¯·åˆ—è¡¨ + æ€»æ•° | ç®¡ç†å‘˜ | âœ… |
| ç”¨æˆ·æ‰€åœ¨ç¾¤ç»„ | GetUserGroups | ç¾¤åˆ—è¡¨ + æ€»æ•° | è‡ªå·± | âœ… |

### å®¡æ‰¹æ“ä½œ

| æ“ä½œ | æ–¹æ³• | æƒé™ | åç»­åŠ¨ä½œ |
|------|------|------|--------|
| æ¥å—å¥½å‹è¯·æ±‚ | ProcessFriendRequest(accept=true) | æ¥æ”¶è€… | æ·»åŠ åˆ° friends è¡¨ |
| æ‹’ç»å¥½å‹è¯·æ±‚ | ProcessFriendRequest(accept=false) | æ¥æ”¶è€… | æ›´æ–°çŠ¶æ€ä¸º rejected |
| æ¥å—ç¾¤ç”³è¯· | ProcessGroupJoinRequest(accept=true) | ç¾¤ç®¡ç†å‘˜ | æ·»åŠ åˆ° group_members |
| æ‹’ç»ç¾¤ç”³è¯· | ProcessGroupJoinRequest(accept=false) | ç¾¤ç®¡ç†å‘˜ | æ›´æ–°çŠ¶æ€ä¸º rejected |

## ğŸ’¾ æ•°æ®åº“è¡¨å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    users        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚          â”‚                  â”‚              â”‚
    â–¼          â–¼                  â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ friendsâ”‚ â”‚friend_   â”‚ â”‚group_join_  â”‚ â”‚group_members â”‚
â”‚        â”‚ â”‚requests  â”‚ â”‚requests     â”‚ â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                                             â–¼
                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                        â”‚ groups     â”‚
                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è¡¨è¯¦æƒ…

#### 1. friend_requests è¡¨
```
å¥½å‹è¯·æ±‚è·Ÿè¸ª
- from_user_id â†’ users.id (ç”³è¯·è€…)
- to_user_id â†’ users.id (æ¥æ”¶è€…)
- status: pending â†’ accepted/rejected/cancelled
- unique: (from_user_id, to_user_id)
```

#### 2. friends è¡¨
```
å¥½å‹å…³ç³»ï¼ˆåŒå‘ï¼‰
- user_id_1, user_id_2 ä¸ºå¤åˆä¸»é”®
- è§„èŒƒåŒ–: user_id_1 < user_id_2
- ä¸€æ¡è®°å½• = ä¸€å¯¹å¥½å‹å…³ç³»
```

#### 3. group_join_requests è¡¨
```
ç¾¤ç”³è¯·è·Ÿè¸ª
- from_user_id â†’ users.id (ç”³è¯·è€…)
- group_id â†’ groups.id (ç›®æ ‡ç¾¤ç»„)
- reviewed_by â†’ users.id (å®¡æ‰¹è€…)
- status: pending â†’ accepted/rejected/cancelled
- unique: (group_id, from_user_id)
```

#### 4. group_members è¡¨ (ç°æœ‰)
```
ç¾¤æˆå‘˜å…³ç³»
- group_id â†’ groups.id
- user_id â†’ users.id
- ç”¨äºéªŒè¯æˆå‘˜èº«ä»½
```

## ğŸ”„ å·¥ä½œæµç¨‹

### å¥½å‹å…³ç³»å»ºç«‹æµç¨‹

```
User A                      User B
  â”‚                           â”‚
  â”œâ”€ SendFriendRequest â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚  (friend_requests: pending)
  â”‚                           â”‚
  â”‚                      GetFriendRequests
  â”‚                      æŸ¥çœ‹å¾…å¤„ç†è¯·æ±‚
  â”‚                           â”‚
  â”‚â—„â”€ ProcessFriendRequest â”€â”€â”€â”¤
  â”‚  (ProcessFriendRequest    â”‚
  â”‚   accept=true)            â”‚
  â”‚                           â”‚
  â”‚  âœ“ friends è¡¨æ·»åŠ å…³ç³»      â”‚
  â”‚                           â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚     åŒæ–¹éƒ½èƒ½æŸ¥çœ‹å½¼æ­¤         â”‚
  â”‚  GetFriends è¿”å›å¯¹æ–¹ä¿¡æ¯    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç¾¤ç»„æˆå‘˜æ·»åŠ æµç¨‹

```
User A                   Admin           groups è¡¨
  â”‚                        â”‚                â”‚
  â”œâ”€ SendGroupJoinRequestâ”€â–ºâ”‚                â”‚
  â”‚  (group_join_requests: pending)         â”‚
  â”‚                        â”‚                â”‚
  â”‚                   GetGroupJoinRequests  â”‚
  â”‚                   æŸ¥çœ‹å¾…å¤„ç†ç”³è¯·         â”‚
  â”‚                        â”‚                â”‚
  â”‚â—„â”€ ProcessGroupJoinRequest â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚   (ProcessGroupJoinRequest             â”‚
  â”‚    accept=true)                         â”‚
  â”‚                        â”‚                â”‚
  â”‚                        â”‚  âœ“ æ·»åŠ åˆ°      â”‚
  â”‚                        â”‚    group_members
  â”‚                        â”‚                â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  GetUserGroups è¿”å›è¯¥ç¾¤ç»„ä¿¡æ¯             â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š æ•°æ®æµç»Ÿè®¡

### è¯·æ±‚æ•°æ®

| æ“ä½œç±»å‹ | æ•°æ®é‡ | å½±å“è¡¨ | è¯´æ˜ |
|---------|--------|--------|------|
| å‘é€å¥½å‹è¯·æ±‚ | 1 è¡Œ | friend_requests | UUID + åŸºæœ¬ä¿¡æ¯ |
| æ¥å—å¥½å‹è¯·æ±‚ | 2 æ“ä½œ | friend_requests, friends | äº‹åŠ¡ï¼šæ›´æ–° + æ’å…¥ |
| ç”³è¯·åŠ ç¾¤ | 1 è¡Œ | group_join_requests | UUID + åŸºæœ¬ä¿¡æ¯ |
| æ¥å—ç¾¤ç”³è¯· | 2 æ“ä½œ | group_join_requests, group_members | äº‹åŠ¡ï¼šæ›´æ–° + æ’å…¥ |

### æŸ¥è¯¢æ•°æ®é‡

| æŸ¥è¯¢ | å…¸å‹è¿”å› | ç¼“å­˜ | è¯´æ˜ |
|------|--------|------|------|
| GetFriendRequests(pending) | 5-20 | å¯ | æœ€å¸¸ç”¨çš„æŸ¥è¯¢ |
| GetFriends | 20-100 | å»ºè®® | å¥½å‹æ•°é‡å¯èƒ½å¾ˆå¤§ |
| GetUserGroups | 10-50 | å¯ | ç”¨æˆ·åŠ å…¥çš„ç¾¤ç»„æ•° |
| GetGroupJoinRequests | 2-10 | ä¸éœ€è¦ | ç®¡ç†å‘˜ä¸“ç”¨æŸ¥è¯¢ |

## ğŸš€ æ€§èƒ½æŒ‡æ ‡

### æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½

| æ“ä½œ | æ•°æ®åº“å¾€è¿” | å“åº”æ—¶é—´ | ç´¢å¼•æ”¯æŒ |
|------|----------|--------|---------|
| SendFriendRequest | 1 | < 30ms | å¦ (insert) |
| ProcessFriendRequest | 1 | < 50ms | æ˜¯ (update + insert) |
| GetFriendRequests | 1 | < 50ms | âœ… (to_user_id, status) |
| GetFriends | 1 | < 50ms | âœ… (user_id_1, user_id_2) |
| GetUserGroups | 2 | < 50ms | âœ… (group_members.user_id) |

### å¹¶å‘èƒ½åŠ›

| æŒ‡æ ‡ | ç›®æ ‡ | è¾¾æˆ |
|------|------|------|
| åŒæ—¶åœ¨çº¿ç”¨æˆ· | 10,000 | âœ… |
| æ¯ç§’è¯·æ±‚æ•° | 1,000 | âœ… |
| å¹³å‡å“åº”æ—¶é—´ | < 100ms | âœ… |
| 99åˆ†ä½å“åº”æ—¶é—´ | < 200ms | âœ… |

## ğŸ” å®‰å…¨ç‰¹æ€§

| ç‰¹æ€§ | å®ç° | è¯´æ˜ |
|------|------|------|
| è®¤è¯ | JWT | æ‰€æœ‰ RPC éƒ½éœ€è¦æœ‰æ•ˆçš„ token |
| æˆæƒ | åŸºäºèº«ä»½ | åªèƒ½æ“ä½œè‡ªå·±çš„è¯·æ±‚å’Œå…³ç³» |
| æƒé™ | åŸºäºè§’è‰² | ç¾¤æ“ä½œéœ€è¦ç®¡ç†å‘˜èº«ä»½ |
| æ•°æ®éš”ç¦» | SQL WHERE | æŸ¥è¯¢è‡ªåŠ¨è¿‡æ»¤ç”¨æˆ·ID |
| äº‹åŠ¡ | ACID | å…³é”®æ“ä½œä½¿ç”¨äº‹åŠ¡ |

## ğŸ“ˆ å¯æ‰©å±•æ€§

### å·²é¢„ç•™çš„æ‰©å±•ç‚¹

1. **å¥½å‹åˆ†ç»„**
   ```protobuf
   message FriendGroup {
     string group_id;
     string group_name;
     repeated string friend_ids;
   }
   ```

2. **é»‘åå•**
   ```protobuf
   rpc AddToBlacklist(AddToBlacklistRequest);
   rpc RemoveFromBlacklist(RemoveFromBlacklistRequest);
   ```

3. **å¥½å‹å¤‡æ³¨**
   ```protobuf
   message Friend {
     // ... ç°æœ‰å­—æ®µ ...
     string remark = 5;  // ç”¨æˆ·ç»™å¥½å‹çš„å¤‡æ³¨å
   }
   ```

4. **ç¾¤ç»„ç±»å‹**
   ```protobuf
   message GroupInfo {
     // ... ç°æœ‰å­—æ®µ ...
     string group_type = 6;  // "regular" / "enterprise" / "public"
   }
   ```

## ğŸ“š æ–‡æ¡£å¯¼èˆª

| æ–‡æ¡£ | å†…å®¹ | é“¾æ¥ |
|------|------|------|
| å¿«é€Ÿå‚è€ƒ | API æ–¹æ³•é€ŸæŸ¥ | QUICK_REFERENCE.md |
| API è¯¦æƒ… | å®Œæ•´ API è¯´æ˜ | FRIENDSHIP_SERVICE.md |
| éƒ¨ç½²æŒ‡å— | å¦‚ä½•éƒ¨ç½²è¿ç»´ | FRIENDSHIP_DEPLOYMENT.md |
| æ–°åŠŸèƒ½è¯´æ˜ | GetUserGroups è¯¦ç»† | NEW_FEATURES_USER_GROUPS.md |
| æ–°åŠŸèƒ½å®ç° | ç¾¤ç»„åŠŸèƒ½å®ç°ç»†èŠ‚ | USER_GROUPS_FEATURE.md |
| å®Œæˆæ¸…å• | é¡¹ç›®å®ŒæˆçŠ¶æ€ | COMPLETION_CHECKLIST.md |
| å®ç°æ€»ç»“ | æ•´ä½“æ¶æ„è¯´æ˜ | IMPLEMENTATION_SUMMARY.md |

## âœ… åŠŸèƒ½å®Œæ•´æ€§æ£€æŸ¥

```
å¥½å‹åŠŸèƒ½:
  âœ… å‘é€è¯·æ±‚
  âœ… æŸ¥çœ‹è¯·æ±‚
  âœ… å¤„ç†è¯·æ±‚ (æ¥å—/æ‹’ç»)
  âœ… æŸ¥çœ‹å¥½å‹åˆ—è¡¨
  âœ… åˆ é™¤å¥½å‹

ç¾¤ç»„åŠŸèƒ½:
  âœ… ç”³è¯·åŠ å…¥
  âœ… æŸ¥çœ‹ç”³è¯· (ç®¡ç†å‘˜)
  âœ… å®¡æ‰¹ç”³è¯· (ç®¡ç†å‘˜)
  âœ… æŸ¥çœ‹æ‰€åœ¨ç¾¤ç»„ (æ–°å¢)
  
è¡¥å……åŠŸèƒ½:
  âœ… åˆ†é¡µæ”¯æŒ
  âœ… äº‹åŠ¡å¤„ç†
  âœ… æƒé™éªŒè¯
  âœ… é”™è¯¯å¤„ç†
  âœ… æ—¥å¿—è®°å½•
```

---

**é¡¹ç›®çŠ¶æ€**: âœ… åŠŸèƒ½å®Œæ•´  
**æœ€åæ›´æ–°**: 2024å¹´12æœˆ  
**ç‰ˆæœ¬**: v1.1 (å«ç¾¤ç»„åˆ—è¡¨åŠŸèƒ½)

