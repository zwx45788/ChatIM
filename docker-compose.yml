version: '3.8'

services:
  # MySQL æ•°æ®åº“
  mysql:
    image: mysql:latest
    container_name: chatim_mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: 060629 # ğŸ‘ˆ è®¾ç½®ä½ çš„ MySQL root å¯†ç 
      MYSQL_DATABASE: chatim
      MYSQL_USER: chatim_user
      MYSQL_PASSWORD: chatim_pass
    ports:
      - "3307:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - chatim_network

  # Redis ç¼“å­˜
  redis:
    image: redis:latest
    container_name: chatim_redis
    restart: unless-stopped
    ports:
      - "6380:6379"
    networks:
      - chatim_network

  # User Service
  user-service:
    build:
      context: .
      dockerfile: cmd/user/Dockerfile
    container_name: chatim_user_service
    restart: unless-stopped
    environment:
      # ğŸ‘ˆ è®©æœåŠ¡é€šè¿‡å®¹å™¨åè®¿é—®æ•°æ®åº“
      CHATIM_DATABASE_MYSQL_DSN: "chatim_user:chatim_pass@tcp(mysql:3306)/chatim?charset=utf8mb4&parseTime=True&loc=Local"
    ports:
      - "50051:50051"
    depends_on:
      - mysql
    networks:
      - chatim_network

  # Message Service
  message-service:
    build:
      context: .
      dockerfile: cmd/message/Dockerfile
    container_name: chatim_message_service
    restart: unless-stopped
    environment:
      CHATIM_DATABASE_MYSQL_DSN: "chatim_user:chatim_pass@tcp(mysql:3306)/chatim?charset=utf8mb4&parseTime=True&loc=Local"
      CHATIM_DATABASE_REDIS_ADDR: "redis:6379" # ğŸ‘ˆ é€šè¿‡æœåŠ¡åè®¿é—® Redis
    ports:
      - "50052:50052"
    depends_on:
      - mysql
      - redis
    networks:
      - chatim_network

  # API Gateway
  api-gateway:
    build:
      context: .
      dockerfile: cmd/api/Dockerfile
    container_name: chatim_api_gateway
    restart: unless-stopped
    environment:
      # ğŸ‘‡ API Gateway ä¹Ÿéœ€è¦è¿æ¥æ•°æ®åº“å’Œ Redis
      CHATIM_DATABASE_MYSQL_DSN: "chatim_user:chatim_pass@tcp(mysql:3306)/chatim?charset=utf8mb4&parseTime=True&loc=Local"
      CHATIM_DATABASE_REDIS_ADDR: "redis:6379"
      # ğŸ‘‡ å‘Šè¯‰ API Gatewayï¼ŒgRPC æœåŠ¡çš„åœ°å€åœ¨å“ªé‡Œï¼ˆä½¿ç”¨æœåŠ¡åï¼‰
      CHATIM_SERVER_USER_GRPC_ADDR: "user-service:50051"
      CHATIM_SERVER_MESSAGE_GRPC_ADDR: "message-service:50052"
    ports:
      - "8081:8080"
    depends_on:
      - user-service
      - message-service
      - redis
    networks:
      - chatim_network

# å®šä¹‰ç½‘ç»œ
networks:
  chatim_network:
    driver: bridge

# å®šä¹‰æ•°æ®å·ï¼ŒæŒä¹…åŒ– MySQL æ•°æ®
volumes:
  mysql_data:

